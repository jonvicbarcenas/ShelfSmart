{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Catalog | ShelfSmart</title>
    <link rel="stylesheet" href="{% static 'css/catalog.css' %}">
    <link rel="stylesheet" href="{% static 'css/user_header.css' %}">
    <link rel="stylesheet" href="{% static 'css/view_book_popup.css' %}">
    <link rel="stylesheet" href="{% static 'css/search_history.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="dashboard">
    <!-- Sidebar -->
    {% with active_page='catalog' %}
        {% include 'components/user_sidebar.html' %}
    {% endwith %}

    <!-- Main Content -->
    <div class="main-content">
        {% include 'components/user_header.html' %}

        <div class="content">
            <h1 class="page-title">Book Catalog</h1>
            
            <!-- Modern Filter, Sort, and Search Bar -->
            <div style="display: flex; gap: 20px; margin-bottom: 30px; align-items: flex-end; flex-wrap: wrap;">
                <!-- Category Filter -->
                <div style="flex: 0 0 280px;">
                    <label for="categoryFilter" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-filter" style="color: #1a1a1a;"></i>
                        Filter by Category
                    </label>
                    <div style="position: relative;">
                        <select id="categoryFilter" onchange="filterByCategory(this.value)" style="width: 100%; padding: 12px 16px; padding-right: 40px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; cursor: pointer; transition: all 0.3s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%231a1a1a%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px;" onfocus="this.style.borderColor='#1a1a1a'; this.style.boxShadow='0 0 0 3px rgba(26, 26, 26, 0.1)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.category_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Sort Control -->
                <div style="flex: 0 0 240px;">
                    <label for="sortSelect" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-sort" style="color: #1a1a1a;"></i>
                        Sort Results
                    </label>
                    <div style="position: relative;">
                        <select id="sortSelect" onchange="sortResults(this.value)" style="width: 100%; padding: 12px 16px; padding-right: 40px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; cursor: pointer; transition: all 0.3s ease; outline: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%231a1a1a%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px;" onfocus="this.style.borderColor='#1a1a1a'; this.style.boxShadow='0 0 0 3px rgba(26, 26, 26, 0.1)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                            <option value="-created_at" {% if selected_sort == '-created_at' %}selected{% endif %}>Newest First</option>
                            <option value="created_at" {% if selected_sort == 'created_at' %}selected{% endif %}>Oldest First</option>
                            <option value="title" {% if selected_sort == 'title' %}selected{% endif %}>Title (A-Z)</option>
                            <option value="-title" {% if selected_sort == '-title' %}selected{% endif %}>Title (Z-A)</option>
                            <option value="category__category_name" {% if selected_sort == 'category__category_name' %}selected{% endif %}>Category (A-Z)</option>
                            <option value="-category__category_name" {% if selected_sort == '-category__category_name' %}selected{% endif %}>Category (Z-A)</option>
                            <option value="publisher__publisher_name" {% if selected_sort == 'publisher__publisher_name' %}selected{% endif %}>Publisher (A-Z)</option>
                            <option value="-publisher__publisher_name" {% if selected_sort == '-publisher__publisher_name' %}selected{% endif %}>Publisher (Z-A)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div style="flex: 0 0 360px;">
                    <label for="searchInput" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-search" style="color: #1a1a1a;"></i>
                        Search Books
                    </label>
                    <div style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #a0aec0; font-size: 14px;"></i>
                        <input type="text" id="searchInput" placeholder="Search by Title, Category, Publisher, Author..." style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; transition: all 0.3s ease; outline: none;" onfocus="this.style.borderColor='#1a1a1a'; this.style.boxShadow='0 0 0 3px rgba(26, 26, 26, 0.1)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';" />
                    </div>
                </div>
                
                <!-- Search History Button -->
                <div style="flex: 0 0 auto; margin-left: 60px; padding-left: 10px;">
                    <label style="display: block; margin-bottom: 8px; opacity: 0; pointer-events: none;">.</label>
                    <button class="search-history-trigger-btn" onclick="SearchHistory.openPopup()" type="button" title="Search History">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>

            <!-- Books Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Publisher</th>
                            <th>Authors</th>
                            <th>Language</th>
                            <th>Quantity</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if books %}
                            {% for book in books %}
                            <tr data-book-id="{{ book.id }}">
                                <td>{{ book.title }}</td>
                                <td><span class="category-badge">{{ book.category.category_name }}</span></td>
                                <td>{{ book.publisher.publisher_name }}</td>
                                <td>
                                    {% if book.book_authors.all %}
                                        {% for book_author in book.book_authors.all %}
                                            {{ book_author.author.name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: #a0aec0; font-style: italic;">No authors</span>
                                    {% endif %}
                                </td>
                                <td>{{ book.language }}</td>
                                <td class="book-quantity">{{ book.quantity }}</td>
                                <td>
                                    <span class="availability-status {% if book.user_availability == 'available' %}available{% elif book.user_availability == 'borrowed' %}borrowed{% else %}unavailable{% endif %}">
                                        {{ book.user_availability|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons-group">
                                        <button class="action-btn view-btn" data-book-id="{{ book.id }}" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if book.user_availability == 'available' %}
                                            <button class="action-btn borrow-btn" data-book-id="{{ book.id }}" data-book-title="{{ book.title }}" title="Borrow Book">
                                                <i class="fas fa-book-reader"></i>
                                            </button>
                                        {% else %}
                                            <button class="action-btn unavailable-btn" disabled title="Not available">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">No books available in the catalog.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include View Book Popup Component -->
{% include 'components/view_book_popup.html' %}

<!-- Include Search History Popup Component -->
{% include 'components/search_history_popup.html' %}

<script src="{% static 'js/view_book_popup.js' %}"></script>
<script src="{% static 'js/search_history.js' %}"></script>
<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Category filter functionality
    function filterByCategory(categoryId) {
        const currentUrl = new URL(window.location.href);
        if (categoryId) {
            currentUrl.searchParams.set('category', categoryId);
        } else {
            currentUrl.searchParams.delete('category');
        }
        window.location.href = currentUrl.toString();
    }

    // Sort results functionality
    function sortResults(sortValue) {
        const currentUrl = new URL(window.location.href);
        if (sortValue) {
            currentUrl.searchParams.set('sort', sortValue);
        } else {
            currentUrl.searchParams.delete('sort');
        }
        window.location.href = currentUrl.toString();
    }

    // Basic search functionality
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toUpperCase();
        let table = document.querySelector('table');
        let tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header
            let rowVisible = false;
            let td = tr[i].getElementsByTagName('td');
            for (let j = 0; j < td.length - 1; j++) { // Exclude actions column
                if (td[j]) {
                    if (td[j].innerHTML.toUpperCase().indexOf(filter) > -1) {
                        rowVisible = true;
                    }
                }
            }
            if (rowVisible) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    });

    // Borrow book functionality
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Setting up borrow buttons...');
        const borrowButtons = document.querySelectorAll('.borrow-btn');
        console.log('Found borrow buttons:', borrowButtons.length);
        
        borrowButtons.forEach((button, index) => {
            console.log(`Setting up button ${index}:`, button);
            console.log(`Button data-book-id: ${button.getAttribute('data-book-id')}`);
            console.log(`Button data-book-title: ${button.getAttribute('data-book-title')}`);
            
            button.addEventListener('click', function(e) {
                console.log('Borrow button clicked!');
                e.preventDefault();
                const bookId = this.getAttribute('data-book-id');
                const bookTitle = this.getAttribute('data-book-title');
                
                console.log('Book ID:', bookId);
                console.log('Book Title:', bookTitle);
                
                if (confirm(`Are you sure you want to borrow "${bookTitle}"?`)) {
                    borrowBook(bookId, this);
                }
            });
        });
        
        console.log('Borrow buttons setup complete');
    });

    function borrowBook(bookId, buttonElement) {
        // Disable button to prevent double-clicking
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrowing...';
        
        fetch(`/user/catalog/borrow/${bookId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert(data.message);
                
                // Update the row in the table
                const row = buttonElement.closest('tr');
                const quantityCell = row.querySelector('.book-quantity');
                const availabilityCell = row.querySelector('.availability-status');
                
                // Update quantity
                quantityCell.textContent = data.new_quantity;
                
                // Update availability
                availabilityCell.textContent = data.new_availability;
                if (data.new_availability === 'Available') {
                    availabilityCell.className = 'availability-status available';
                } else {
                    availabilityCell.className = 'availability-status borrowed';
                }
                
                // Update button
                if (data.new_availability === 'Available' && data.new_quantity > 0) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fas fa-book-reader"></i> Borrow';
                } else {
                    buttonElement.innerHTML = '<i class="fas fa-ban"></i> Unavailable';
                    buttonElement.style.opacity = '0.5';
                    buttonElement.style.cursor = 'not-allowed';
                }
            } else {
                // Show error message
                alert(data.message);
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-book-reader"></i> Borrow';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while borrowing the book. Please try again.');
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-book-reader"></i> Borrow';
        });
    }

    // Configure and initialize view book popup for catalog
    document.addEventListener('DOMContentLoaded', function() {
        // Configure the API endpoint for catalog
        if (typeof ViewBookPopupConfig !== 'undefined') {
            ViewBookPopupConfig.apiEndpoint = '/user/catalog/api/book/';
        }
        
        // View button event listener
        const viewButtons = document.querySelectorAll('.view-btn');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                if (bookId) {
                    viewBook(bookId);
                }
            });
        });
    });
</script>
</body>
</html>
