{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfSmart Library Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-dots">
                    <div class="dot dot-1"></div>
                    <div class="dot dot-2"></div>
                    <div class="dot dot-3"></div>
                    <div class="dot dot-4"></div>
                    <div class="dot dot-5"></div>
                    <div class="dot dot-6"></div>
                    <div class="dot dot-7"></div>
                </div>
                <h2 class="brand-title">ShelfSmart</h2>
                <p class="brand-subtitle">LIBRARY</p>
            </div>
            <nav class="nav-menu">
                <a href="{% url 'dashboard' %}" class="nav-link active">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{% url 'catalog_admin' %}" class="nav-link">
                    <i class="fas fa-book-open"></i>
                    <span>Catalog</span>
                </a>
                <a href="{% url 'book_management' %}" class="nav-link">
                    <i class="fas fa-book"></i>
                    <span>Books</span>
                </a>
                <a href="{% url 'user_management' %}" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
            </nav>
            <a href="{% url 'admin_profile' %}" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
            <div class="logout">
                <a href="#" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log Out</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="headerUserName">{{ user_name|default:"Admin" }}</div>
                        <div class="user-role">Admin</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="time-date-container">
                        <div class="time" id="currentTime">12:29 PM</div>
                        <div class="current-date" id="currentDate">Oct 02, 2025</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Left Section (Chart and Stats) -->
                <div class="left-section">
                    <!-- Chart -->
                    <div class="chart-section">
                        <canvas id="borrowChart"></canvas>
                        <div class="chart-legend">
                            <div class="legend-box">
                                <div class="legend-left">
                                    <div class="logo-dots small">
                                        <div class="dot dot-1"></div>
                                        <div class="dot dot-2"></div>
                                        <div class="dot dot-3"></div>
                                        <div class="dot dot-4"></div>
                                        <div class="dot dot-5"></div>
                                        <div class="dot dot-6"></div>
                                        <div class="dot dot-7"></div>
                                    </div>
                                </div>
                                <div class="legend-divider"></div>
                                <div class="legend-right">
                                    <div class="legend-item">
                                        <span class="legend-dot borrowed"></span>
                                        <span>Total Borrowed Books</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-dot returned"></span>
                                        <span>Total Returned Books</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section (Stats and Lists) -->
                <div class="right-section">
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalUsers">{{ total_users|default:"0" }}</h3>
                                    <p>Total User Base</p>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalBooks">{{ total_books|default:"0" }}</h3>
                                    <p>Total Book Count</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Main Sections -->
                    <div class="main-sections">
                        <!-- Overdue Borrowers -->
                        <div class="section-container">
                            <h2>Overdue Borrowers</h2>
                            <div class="list" id="overdueBorrowersList">
                                {% for borrower in overdue_borrowers %}
                                <div class="list-item">
                                    <div class="list-item-content">
                                        <div class="user-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="info-text">
                                            <h4>{{ borrower.users.name|default:"Unknown User" }}</h4>
                                            <p>Borrow ID: {{ borrower.id }}</p>
                                        </div>
                                    </div>
                                    <button class="edit-btn" title="Mark as Returned" onclick="markAsReturned({{ borrower.id }})">
                                        <i class="fas fa-arrows-rotate"></i>
                                    </button>
                                </div>
                                {% empty %}
                                <p style="text-align: center; padding: 20px; color: #666;">No overdue borrowers</p>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- BookWorm Admins -->
                        <div class="section-container">
                            <h2>ShelfSmart Admins</h2>
                            <div class="list" id="adminsList">
                                {% for admin in admins %}
                                <div class="list-item">
                                    <div class="list-item-content">
                                        <div class="admin-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="info-text">
                                            <h4>{{ admin.name }}</h4>
                                            <p>Admin ID: {{ admin.id }}</p>
                                        </div>
                                        <span class="status-dot active"></span>
                                    </div>
                                </div>
                                {% empty %}
                                <p style="text-align: center; padding: 20px; color: #666;">No admins found</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Update time and date
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', hour12: true 
            });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
                month: 'short', day: '2-digit', year: 'numeric' 
            });
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Chart data from backend
        const borrowedCount = {{ total_borrowed|default:"0" }};
        const returnedCount = {{ total_returned|default:"0" }};

        // Create chart
        const ctx = document.getElementById('borrowChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Borrowed Books',
                    data: [borrowedCount, borrowedCount * 0.9, borrowedCount * 1.1, borrowedCount * 0.8, 
                           borrowedCount * 1.2, borrowedCount, borrowedCount * 0.95, borrowedCount * 1.05,
                           borrowedCount * 0.9, borrowedCount, borrowedCount * 1.1, borrowedCount],
                    backgroundColor: '#4CAF50',
                    borderRadius: 8
                }, {
                    label: 'Returned Books',
                    data: [returnedCount, returnedCount * 1.1, returnedCount * 0.9, returnedCount * 1.2,
                           returnedCount * 0.8, returnedCount, returnedCount * 1.05, returnedCount * 0.95,
                           returnedCount, returnedCount * 1.1, returnedCount * 0.9, returnedCount],
                    backgroundColor: '#2196F3',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Mark as returned function
        function markAsReturned(borrowId) {
            if (confirm('Mark this book as returned?')) {
                fetch(`/api/mark-returned/${borrowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          location.reload();
                      } else {
                          alert('Error: ' + data.message);
                      }
                  });
            }
        }
    </script>
</body>
</html>