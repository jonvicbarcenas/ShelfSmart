{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Management | ShelfSmart</title>
    <link rel="stylesheet" href="{% static 'css/book_management.css' %}">
    <link rel="stylesheet" href="{% static 'css/popup_styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/user_header.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Centralized View Book Popup CSS -->
    <link rel="stylesheet" href="{% static 'css/view_book_popup.css' %}">
    
    <!-- Action Button Styles -->
    <link rel="stylesheet" href="{% static 'css/view_button.css' %}">
    <link rel="stylesheet" href="{% static 'css/action_buttons/edit_button.css' %}">
    <link rel="stylesheet" href="{% static 'css/action_buttons/delete_button.css' %}">
</head>
<body>
<div class="dashboard">
    <!-- Sidebar -->
    {% include 'components/admin_sidebar.html' with active_page='books' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
                <div class="user-header__left">
                    <div class="user-header__avatar">
                        <svg class="user-header__avatar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="user-header__details">
                        <span class="user-header__name">
                            {{ user_info.full_name|default:"Jon Vic Barcenas" }}
                            <span class="user-header__role">({{ user_info.role|default:"Admin" }})</span>
                        </span>
                        <span class="user-header__handle">@{{ user_info.username|default:"Dainsleif" }}</span>
                    </div>
                </div>
                <div class="user-header__timestamp" id="currentTime">
                    <!-- The time will be updated by the JavaScript below -->
                </div>
            </div>

        <div class="content">
            <div class="content-header">
                <h1 class="page-title">Book Management</h1>
                <div class="header-actions">
                    <button class="add-book-btn" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        Add Book
                    </button>
                </div>
            </div>

            <!-- Filter, Sort, and Search Bar (Admin) -->
            <div style="display: flex; gap: 20px; margin-bottom: 30px; align-items: flex-end; flex-wrap: wrap;">
                <!-- Category Filter -->
                <div style="flex: 0 0 280px;">
                    <label for="categoryFilter" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-filter" style="color: #1a1a1a;"></i>
                        Filter by Category
                    </label>
                    <div style="position: relative;">
                        <select id="categoryFilter" onchange="filterByCategory(this.value)" style="width: 100%; padding: 12px 16px; padding-right: 40px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; cursor: pointer; transition: all 0.3s ease; outline: none; appearance: none;">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.category_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Sort Control -->
                <div style="flex: 0 0 240px;">
                    <label for="sortSelect" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-sort" style="color: #1a1a1a;"></i>
                        Sort Results
                    </label>
                    <div style="position: relative;">
                        <select id="sortSelect" onchange="sortResults(this.value)" style="width: 100%; padding: 12px 16px; padding-right: 40px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; cursor: pointer; transition: all 0.3s ease; outline: none; appearance: none;">
                            <option value="-created_at" {% if selected_sort == '-created_at' %}selected{% endif %}>Newest First</option>
                            <option value="created_at" {% if selected_sort == 'created_at' %}selected{% endif %}>Oldest First</option>
                            <option value="title" {% if selected_sort == 'title' %}selected{% endif %}>Title (A-Z)</option>
                            <option value="-title" {% if selected_sort == '-title' %}selected{% endif %}>Title (Z-A)</option>
                            <option value="category__category_name" {% if selected_sort == 'category__category_name' %}selected{% endif %}>Category (A-Z)</option>
                            <option value="-category__category_name" {% if selected_sort == '-category__category_name' %}selected{% endif %}>Category (Z-A)</option>
                            <option value="publisher__publisher_name" {% if selected_sort == 'publisher__publisher_name' %}selected{% endif %}>Publisher (A-Z)</option>
                            <option value="-publisher__publisher_name" {% if selected_sort == '-publisher__publisher_name' %}selected{% endif %}>Publisher (Z-A)</option>
                        </select>
                    </div>
                </div>

                <!-- Search Bar -->
                <div style="flex: 0 0 360px;">
                    <label for="searchInput" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #2d3748; font-size: 14px;">
                        <i class="fas fa-search" style="color: #1a1a1a;"></i>
                        Search Books
                    </label>
                    <div style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #a0aec0; font-size: 14px;"></i>
                        <input type="text" id="searchInput" placeholder="Search by Title, Category, Publisher, Author..." style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; color: #2d3748; background: white; transition: all 0.3s ease; outline: none;" />
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Book ID</th>
                            <th>ISBN</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Publisher</th>
                            <th>Authors</th>
                            <th>Language</th>
                            <th>Quantity</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="booksTableBody">
                        {% for book in books %}
                        <tr data-id="{{ book.id }}">
                            <td>{{ book.book_id }}</td>
                            <td>{{ book.isbn|default:"-" }}</td>
                            <td>{{ book.title }}</td>
                            <td><span class="category-badge">{{ book.category_name }}</span></td>
                            <td>{{ book.publisher_name }}</td>
                            <td>{{ book.authors }}</td>
                            <td>{{ book.language }}</td>
                            <td>{{ book.quantity }}</td>
                            <td>
                                <span class="status-badge {% if book.availability == 'available' %}available{% else %}borrowed{% endif %}">
                                    {{ book.availability|title }}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn btn-view" title="View" onclick="viewBook({{ book.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn btn-edit" title="Edit" onclick="editBook({{ book.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn btn-delete" title="Delete" onclick="deleteBook({{ book.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">No books found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Book Popup -->
<div id="addBookPopup" class="popup-overlay">
    <div class="popup-container">
        <div class="popup-header">
            <h3 class="popup-title">
                <i class="fas fa-book"></i>
                Add New Book
            </h3>
            <button class="popup-close" onclick="closeAddPopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="popup-content">
            <form id="addBookForm" onsubmit="addBook(event)">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="form-group">
                    <label for="add-title">Title <span class="required">*</span></label>
                    <input type="text" id="add-title" name="title" placeholder="Enter book title" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group isbn-group">
                        <label for="add-isbn">ISBN (10 or 13 digits)</label>
                        <div class="isbn-input-wrapper">
                            <input type="text" id="add-isbn" name="isbn" placeholder="Enter ISBN-10 or ISBN-13" maxlength="13">
                            <button type="button" class="btn-validate-isbn" onclick="validateISBN()" title="Validate and auto-fill book details">
                                <i class="fas fa-check-circle"></i>
                                Validate ISBN
                            </button>
                        </div>
                        <div id="isbn-status" class="isbn-status"></div>
                    </div>
                    <div class="form-group">
                        <label for="add-subtitle">Subtitle</label>
                        <input type="text" id="add-subtitle" name="subtitle" placeholder="Enter subtitle">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="add-description">Description</label>
                    <textarea id="add-description" name="description" placeholder="Enter book description" rows="3"></textarea>
                </div>
                
                <!-- Authors Section -->
                <div class="authors-section">
                    <div class="authors-section-header">
                        <h4>Authors <span class="required">*</span></h4>
                        <button type="button" class="add-author-btn" onclick="addAuthorField()">
                            <i class="fas fa-plus"></i>
                            Add Author
                        </button>
                    </div>
                    <div id="authorsContainer">
                        <!-- Author fields will be added here dynamically -->
                        <div class="author-entry" data-author-index="0">
                            <div class="form-group">
                                <label for="author-0">Author Name</label>
                                <select id="author-0" name="authors[]" class="author-select" required>
                                    <option value="">Select Author</option>
                                    {% for author in authors %}
                                        <option value="{{ author.id }}">{{ author.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="author-role-0">Role</label>
                                <select id="author-role-0" name="author_roles[]" class="author-role-select" required>
                                    <option value="primary">Primary Author</option>
                                    <option value="co-author">Co-Author</option>
                                    <option value="editor">Editor</option>
                                    <option value="translator">Translator</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Publication Details -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-category">Category <span class="required">*</span></label>
                        <select id="add-category" name="category_id" required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="add-publisher">Publisher <span class="required">*</span></label>
                        <select id="add-publisher" name="publisher_id" required>
                            <option value="">Select Publisher</option>
                            {% for publisher in publishers %}
                                <option value="{{ publisher.id }}">{{ publisher.publisher_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="add-publication-date">Publication Date</label>
                        <input type="date" id="add-publication-date" name="publication_date">
                    </div>
                    <div class="form-group">
                        <label for="add-edition">Edition</label>
                        <input type="text" id="add-edition" name="edition" placeholder="e.g., 1st, 2nd">
                    </div>
                    <div class="form-group">
                        <label for="add-pages">Pages</label>
                        <input type="number" id="add-pages" name="pages" placeholder="Number of pages" min="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-language">Language</label>
                        <input type="text" id="add-language" name="language" placeholder="Enter language" value="English">
                    </div>
                    <div class="form-group">
                        <label for="add-cover-image">Cover Image URL</label>
                        <input type="url" id="add-cover-image" name="cover_image_url" placeholder="https://example.com/cover.jpg">
                    </div>
                </div>
                
                <!-- Inventory Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-total-copies">Total Copies <span class="required">*</span></label>
                        <input type="number" id="add-total-copies" name="total_copies" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="add-quantity">Available Quantity <span class="required">*</span></label>
                        <input type="number" id="add-quantity" name="quantity" value="1" min="1" required>
                    </div>
                </div>
                
                <div class="popup-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAddPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Book
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Book Popup -->
<div id="updateBookPopup" class="popup-overlay">
    <div class="popup-container">
        <div class="popup-header">
            <h3 class="popup-title">
                <i class="fas fa-edit"></i>
                Update Book
            </h3>
            <button class="popup-close" onclick="closeUpdatePopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="popup-content">
            <form id="updateBookForm" onsubmit="updateBook(event)">
                {% csrf_token %}
                <input type="hidden" id="update-book-id" name="book_id">
                
                <!-- Basic Information -->
                <div class="form-group">
                    <label for="update-title">Title <span class="required">*</span></label>
                    <input type="text" id="update-title" name="title" placeholder="Enter book title" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="update-isbn">ISBN (10 or 13 digits)</label>
                        <input type="text" id="update-isbn" name="isbn" placeholder="Enter ISBN-10 or ISBN-13" maxlength="13">
                    </div>
                    <div class="form-group">
                        <label for="update-subtitle">Subtitle</label>
                        <input type="text" id="update-subtitle" name="subtitle" placeholder="Enter subtitle">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="update-description">Description</label>
                    <textarea id="update-description" name="description" placeholder="Enter book description" rows="3"></textarea>
                </div>
                
                <!-- Publication Details -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="update-category">Category <span class="required">*</span></label>
                        <select id="update-category" name="category_id" required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="update-publisher">Publisher <span class="required">*</span></label>
                        <select id="update-publisher" name="publisher_id" required>
                            <option value="">Select Publisher</option>
                            {% for publisher in publishers %}
                                <option value="{{ publisher.id }}">{{ publisher.publisher_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="update-publication-date">Publication Date</label>
                        <input type="date" id="update-publication-date" name="publication_date">
                    </div>
                    <div class="form-group">
                        <label for="update-edition">Edition</label>
                        <input type="text" id="update-edition" name="edition" placeholder="e.g., 1st, 2nd">
                    </div>
                    <div class="form-group">
                        <label for="update-pages">Pages</label>
                        <input type="number" id="update-pages" name="pages" placeholder="Number of pages" min="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="update-language">Language</label>
                        <input type="text" id="update-language" name="language" placeholder="Enter language">
                    </div>
                    <div class="form-group">
                        <label for="update-cover-image">Cover Image URL</label>
                        <input type="url" id="update-cover-image" name="cover_image_url" placeholder="https://example.com/cover.jpg">
                    </div>
                </div>
                
                <!-- Inventory Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="update-total-copies">Total Copies <span class="required">*</span></label>
                        <input type="number" id="update-total-copies" name="total_copies" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="update-quantity">Available Quantity <span class="required">*</span></label>
                        <input type="number" id="update-quantity" name="quantity" min="1" required>
                    </div>
                </div>
                
                <div class="popup-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeUpdatePopup()">Cancel</button>
                    <button type="submit" class="btn btn-update">
                        <i class="fas fa-save"></i>
                        Update Book
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Centralized View Book Popup Component -->
{% include 'components/view_book_popup.html' %}

<!-- Delete Confirmation Popup -->
<div id="deleteBookPopup" class="popup-overlay">
    <div class="popup-container">
        <div class="popup-header">
            <h3 class="popup-title">
                <i class="fas fa-trash"></i>
                Delete Confirmation
            </h3>
            <button class="popup-close" onclick="closeDeletePopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="popup-content">
            <div class="delete-message">
                Are you certain you wish to proceed with the deletion of the selected entry?
            </div>
            <div class="popup-actions">
                <button type="button" class="btn btn-cancel" onclick="closeDeletePopup()">Cancel</button>
                <button type="button" class="btn btn-confirm" onclick="confirmDelete()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Confirmation Popup -->
<div id="quickAddConfirmPopup" class="popup-overlay" style="z-index: 2000;">
    <div class="popup-container" style="max-width: 450px;">
        <div class="popup-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <h3 class="popup-title">
                <i class="fas fa-plus-circle"></i>
                Quick Add Confirmation
            </h3>
            <button class="popup-close" onclick="cancelQuickAdd()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="popup-content">
            <div class="quick-add-message">
                <div class="quick-add-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <p id="quickAddMessage">
                    Add <strong><span id="quickAddType"></span></strong> 
                    <strong>"<span id="quickAddName"></span>"</strong> 
                    to the database?
                </p>
                <small style="color: #666; display: block; margin-top: 8px;">
                    This will create a new entry and refresh the page.
                </small>
            </div>
            <div class="popup-actions">
                <button type="button" class="btn btn-cancel" onclick="cancelQuickAdd()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmQuickAdd()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <i class="fas fa-plus"></i>
                    Add
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/popup_functions.js' %}?v=7.0"></script>
<script src="{% static 'js/quick_add.js' %}?v=6.0"></script>

<!-- Centralized View Book Popup Script -->
<script src="{% static 'js/view_book_popup.js' %}"></script>
<script>
    // Initialize view book popup with admin API endpoint
    initializeViewBookPopup({
        apiEndpoint: '/admin-panel/books/api/book/'
    });
</script>

<!-- Action Button Scripts -->
<script src="{% static 'js/action_buttons/edit_button.js' %}?v=2.0"></script>
<script src="{% static 'js/action_buttons/delete_button.js' %}?v=1.1"></script>
<script>
    // Category filter functionality
    function filterByCategory(categoryId) {
        const currentUrl = new URL(window.location.href);
        if (categoryId) {
            currentUrl.searchParams.set('category', categoryId);
        } else {
            currentUrl.searchParams.delete('category');
        }
        window.location.href = currentUrl.toString();
    }

    // Sort results functionality
    function sortResults(sortValue) {
        const currentUrl = new URL(window.location.href);
        if (sortValue) {
            currentUrl.searchParams.set('sort', sortValue);
        } else {
            currentUrl.searchParams.delete('sort');
        }
        window.location.href = currentUrl.toString();
    }

    // Basic client-side search within the current table
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;

        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toUpperCase();
            const table = document.querySelector('.table-container table');
            if (!table) return;
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) { // skip header
                let rowVisible = false;
                const td = tr[i].getElementsByTagName('td');
                for (let j = 0; j < td.length - 1; j++) { // exclude actions column
                    if (td[j] && td[j].innerText.toUpperCase().indexOf(filter) > -1) {
                        rowVisible = true;
                        break;
                    }
                }
                tr[i].style.display = rowVisible ? '' : 'none';
            }
        });
    });
</script>
</body>
</html>
