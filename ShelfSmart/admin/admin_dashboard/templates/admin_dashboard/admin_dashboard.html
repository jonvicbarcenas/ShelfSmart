{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfSmart Library Dashboard</title>
        <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=1.1">
    <link rel="stylesheet" href="{% static 'css/user_header.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        {% include 'components/admin_sidebar.html' with active_page='dashboard' %}

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="user-header__left">
                    <div class="user-header__avatar">
                        <svg class="user-header__avatar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="user-header__details">
                        <span class="user-header__name">
                            {{ user_info.full_name|default:"Jon Vic Barcenas" }}
                            <span class="user-header__role">({{ user_info.role|default:"Admin" }})</span>
                        </span>
                        <span class="user-header__handle">@{{ user_info.username|default:"Dainsleif" }}</span>
                    </div>
                </div>
                <div class="user-header__timestamp" id="currentTime">
                    <!-- The time will be updated by the JavaScript below -->
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Left Section (Chart and Stats) -->
                <div class="left-section">
                    <!-- Chart -->
                    <div class="chart-section">
                        <canvas id="borrowChart"></canvas>
                        <div class="chart-legend">
                            <div class="legend-box">
                                <div class="legend-left">
                                    <div class="logo-dots small">
                                        <div class="dot dot-1"></div>
                                        <div class="dot dot-2"></div>
                                        <div class="dot dot-3"></div>
                                        <div class="dot dot-4"></div>
                                        <div class="dot dot-5"></div>
                                        <div class="dot dot-6"></div>
                                        <div class="dot dot-7"></div>
                                    </div>
                                </div>
                                <div class="legend-divider"></div>
                                <div class="legend-right">
                                    <div class="legend-item">
                                        <span class="legend-dot borrowed"></span>
                                        <span>Total Borrowed Books: {{ total_borrowed }}</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-dot returned"></span>
                                        <span>Total Returned Books: {{ total_returned }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section (Stats and Lists) -->
                <div class="right-section">
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalUsers">{{ total_users|default:"0" }}</h3>
                                    <p>Total User Base</p>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalBooks">{{ total_books|default:"0" }}</h3>
                                    <p>Total Book Count</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Main Sections -->
                    <div class="main-sections">
                        <!-- Overdue Borrowers -->
                        <div class="section-container">
                            <h2>Overdue Borrowers</h2>
                            <div class="list" id="overdueBorrowersList">
                                {% for borrower in overdue_borrowers %}
                                <div class="list-item">
                                    <div class="list-item-content">
                                        <div class="user-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="info-text">
                                            <h4>{{ borrower.user_name }}</h4>
                                            <p>
                                                <i class="fas fa-book"></i> {{ borrower.book_name }}<br>
                                                <i class="fas fa-exclamation-circle" style="color: #d32f2f;"></i> 
                                                <span style="color: #d32f2f; font-weight: bold;">{{ borrower.days_overdue }} day{{ borrower.days_overdue|pluralize }} overdue</span>
                                            </p>
                                        </div>
                                    </div>
                                    <button class="edit-btn" title="Mark as Returned" onclick="markAsReturned({{ borrower.id }})">
                                        <i class="fas fa-arrows-rotate"></i>
                                    </button>
                                </div>
                                {% empty %}
                                <p style="text-align: center; padding: 20px; color: #666;">No overdue borrowers</p>
                                {% endfor %}
                            </div>
                            
                            <!-- Pagination Controls -->
                            {% if overdue_borrowers.has_other_pages %}
                            <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 15px; padding: 10px;">
                                {% if overdue_borrowers.has_previous %}
                                    <a href="?page=1" class="pagination-btn" style="padding: 6px 12px; background: #000; color: #fff; border-radius: 4px; text-decoration: none; font-size: 12px; transition: opacity 0.2s;">&laquo; First</a>
                                    <a href="?page={{ overdue_borrowers.previous_page_number }}" class="pagination-btn" style="padding: 6px 12px; background: #000; color: #fff; border-radius: 4px; text-decoration: none; font-size: 12px; transition: opacity 0.2s;">&lsaquo; Prev</a>
                                {% endif %}
                                
                                <span style="font-size: 12px; font-weight: 600; color: #000; margin: 0 5px;">
                                    Page {{ overdue_borrowers.number }} of {{ overdue_borrowers.paginator.num_pages }}
                                </span>
                                
                                {% if overdue_borrowers.has_next %}
                                    <a href="?page={{ overdue_borrowers.next_page_number }}" class="pagination-btn" style="padding: 6px 12px; background: #000; color: #fff; border-radius: 4px; text-decoration: none; font-size: 12px; transition: opacity 0.2s;">Next &rsaquo;</a>
                                    <a href="?page={{ overdue_borrowers.paginator.num_pages }}" class="pagination-btn" style="padding: 6px 12px; background: #000; color: #fff; border-radius: 4px; text-decoration: none; font-size: 12px; transition: opacity 0.2s;">Last &raquo;</a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- BookWorm Admins -->
                        <div class="section-container">
                            <h2>ShelfSmart Admins</h2>
                            <div class="list" id="adminsList">
                                {% for admin in admins %}
                                <div class="admin-item">
                                    <div class="admin-avatar">{{ admin.first_name|slice:":1" }}{{ admin.last_name|slice:":1" }}</div>
                                    <div class="admin-info">
                                        <p class="admin-name">{{ admin.first_name }} {{ admin.last_name }}</p>
                                        <p class="admin-role">{{ admin.user_type|capfirst }}</p>
                                    </div>
                                </div>
                                {% empty %}
                                <p>No active admins found.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Update time and date
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', hour12: true 
            });

        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Chart data from backend - Real monthly statistics
        const monthlyBorrowed = {{ monthly_borrowed|safe }};
        const monthlyReturned = {{ monthly_returned|safe }};

        // Create chart
        const ctx = document.getElementById('borrowChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Borrowed Books',
                    data: monthlyBorrowed,
                    backgroundColor: '#4CAF50',
                    borderRadius: 8
                }, {
                    label: 'Returned Books',
                    data: monthlyReturned,
                    backgroundColor: '#2196F3',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });

        // Mark as returned function
        function markAsReturned(borrowId) {
            if (confirm('Mark this book as returned?')) {
                fetch(`/api/mark-returned/${borrowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          location.reload();
                      } else {
                          alert('Error: ' + data.message);
                      }
                  });
            }
        }
    </script>
</body>
</html>