{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog Admin | ShelfSmart</title>
    <link rel="stylesheet" href="{% static 'css/catalog_admin.css' %}">
    <link rel="stylesheet" href="{% static 'css/user_header.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="dashboard">
    <!-- Sidebar -->
    {% include 'components/admin_sidebar.html' with active_page='catalog' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
                <div class="user-header__left">
                    <div class="user-header__avatar">
                        <svg class="user-header__avatar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="user-header__details">
                        <span class="user-header__name">
                            {{ user_info.full_name|default:"Jon Vic Barcenas" }}
                            <span class="user-header__role">({{ user_info.role|default:"Admin" }})</span>
                        </span>
                        <span class="user-header__handle">@{{ user_info.username|default:"Dainsleif" }}</span>
                    </div>
                </div>
                <div class="user-header__timestamp" id="currentTime">
                    <!-- The time will be updated by the JavaScript below -->
                </div>
            </div>

        <div class="content">
            <h1 class="page-title">Catalog Management</h1>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="borrowed" onclick="switchTab('borrowed')">Borrowed Books</button>
                <button class="tab-btn" data-tab="overdue" onclick="switchTab('overdue')">Overdue Borrowers</button>
            </div>

            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by ID or User">
            </div>

            <!-- Borrowed Books Table -->
            <div class="table-container tab-content active" id="borrowed-tab">
                <table>
                    <thead>
                        <tr>
                            <th>Borrow ID</th>
                            <th>User Name</th>
                            <th>Book Title</th>
                            <th>Borrowed Date</th>
                            <th>Due Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in borrowed_books %}
                        <tr>
                            <td>{{ record.id }}</td>
                            <td>
                                {% if record.user %}
                                    {{ record.user.first_name }} {{ record.user.last_name }}
                                    <br>
                                    <small style="color: #666;">@{{ record.user.username }}</small>
                                {% else %}
                                    Unknown User
                                {% endif %}
                            </td>
                            <td>
                                {{ record.book.title|default:"Unknown Book" }}
                                <br>
                                <small style="color: #666;">
                                    <i class="fas fa-tag"></i> {{ record.book.type }} • 
                                    <i class="fas fa-language"></i> {{ record.book.language }}
                                </small>
                            </td>
                            <td>{{ record.borrowed_date|date:"M d, Y" }}</td>
                            <td>{{ record.due_date|date:"M d, Y" }}</td>
                            <td>
                                <button class="delete-btn" onclick="markAsReturned({{ record.id }})" title="Mark as Returned">
                                    <i class="fas fa-check"></i> Return
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">No borrowed books found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Overdue Borrowers Table -->
            <div class="table-container tab-content" id="overdue-tab">
                <table>
                    <thead>
                        <tr>
                            <th>Borrow ID</th>
                            <th>User Name</th>
                            <th>Book Title</th>
                            <th>Borrowed Date</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in overdue_books %}
                        <tr style="background-color: #fff5f5; border-left: 4px solid #d32f2f;">
                            <td>{{ record.id }}</td>
                            <td>
                                {% if record.user %}
                                    {{ record.user.first_name }} {{ record.user.last_name }}
                                    <br>
                                    <small style="color: #666;">@{{ record.user.username }}</small>
                                {% else %}
                                    Unknown User
                                {% endif %}
                            </td>
                            <td>
                                {{ record.book.title|default:"Unknown Book" }}
                                <br>
                                <small style="color: #666;">
                                    <i class="fas fa-tag"></i> {{ record.book.type }} • 
                                    <i class="fas fa-language"></i> {{ record.book.language }}
                                </small>
                            </td>
                            <td>{{ record.borrowed_date|date:"M d, Y" }}</td>
                            <td>{{ record.due_date|date:"M d, Y" }}</td>
                            <td>
                                <span style="color: #d32f2f; font-weight: bold; background: #ffebee; padding: 4px 8px; border-radius: 4px;">
                                    <i class="fas fa-exclamation-circle"></i> {{ record.days_overdue }} day{{ record.days_overdue|pluralize }}
                                </span>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="markAsReturned({{ record.id }})" title="Mark as Returned">
                                    <i class="fas fa-check"></i> Return
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">No overdue books found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Update time and date
    function updateDateTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', minute: '2-digit', hour12: true 
        });
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
            month: 'short', day: '2-digit', year: 'numeric' 
        });
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabName) {
                btn.classList.add('active');
            }
        });

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + '-tab').classList.add('active');
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const activeTab = document.querySelector('.tab-content.active');
        const rows = activeTab.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Mark as returned
    function markAsReturned(borrowId) {
        if (confirm('Mark this book as returned?')) {
            fetch('/admin-panel/catalog/admin/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    action: 'return',
                    borrow_id: borrowId
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error marking as returned');
                }
            });
        }
    }
</script>
</body>
</html>